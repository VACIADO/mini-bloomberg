<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mini Bloomberg Pro â€“ CFD Real Time</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#121212; color:#fff; display:flex; flex-wrap:wrap; gap:10px; padding:10px; justify-content:center;}
.panel {border:1px solid #444; border-radius:8px; background:#1e1e1e; padding:10px; flex:1 1 45%; min-width:300px; display:flex; flex-direction:column; height:420px;}
h2 {margin:0 0 5px 0; text-align:center; font-size:1.1rem;}
.tradingview-widget-container {flex:1; margin-top:5px; border-radius:6px; overflow:hidden;}
#cfd-container {flex:1; border:1px solid #444; border-radius:6px; position:relative;}
#cfd-canvas {width:100%; height:100%; display:block;}
#ia-news-container {display:flex; gap:10px; flex:1; margin-top:8px;}
#ia-console {flex:1; background:#000; color:#0f0; font-family:monospace; padding:6px; overflow-y:auto; font-size:0.8rem; border-radius:4px; border:1px solid #444; height:180px;}
.news-panel{flex:1; background:#121921; padding:10px; border-radius:6px; max-height:180px; overflow-y:auto;}
.news-panel h3{margin:0 0 5px 0; font-size:14px;}
.alert{background:#7c2d12;color:#fff;padding:6px;text-align:center;font-weight:bold;margin:4px 0;border-radius:4px;}
input, button {padding:4px; border-radius:4px; border:none; background:#333; color:#fff; margin-top:4px;}
canvas{image-rendering:pixelated;}
</style>
</head>
<body>

<!-- PANEL EURO / CORRELADOS -->
<div class="panel" id="panel-eurodolar">
<h2>Euro / Correlados</h2>
<div class="tradingview-widget-container" id="tv_eurodolar"></div>
<div class="tradingview-widget-container" id="tv_bono_eu"></div>
<div class="tradingview-widget-container" id="tv_oro"></div>
<div class="tradingview-widget-container" id="tv_brent"></div>
<div class="tradingview-widget-container" id="tv_btc"></div>
</div>

<!-- PANEL DXY / CORRELADOS -->
<div class="panel" id="panel-dxy">
<h2>DXY / Correlados</h2>
<div class="tradingview-widget-container" id="tv_dxy"></div>
<div class="tradingview-widget-container" id="tv_bono_us"></div>
<div class="tradingview-widget-container" id="tv_nasdaq"></div>
<div class="tradingview-widget-container" id="tv_sp500"></div>
<div class="tradingview-widget-container" id="tv_vix"></div>
</div>

<!-- PANEL CFD REAL-TIME -->
<div class="panel" id="panel-cfd">
<h2>CFD SintÃ©tico â€“ Real Time</h2>
<div id="cfd-container">
  <canvas id="cfd-canvas"></canvas>
</div>
<div id="ia-news-container">
  <div id="ia-console"></div>
  <div class="news-panel">
    <h3>Mini Chat IA / Noticias</h3>
    <input type="text" id="chat-input" placeholder="Escribe noticia o pregunta">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>
<div id="alertBox"></div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
// ==== TRADINGVIEW WIDGETS ====
function crearWidget(symbol, containerId){
  document.getElementById(containerId).innerHTML="";
  new TradingView.widget({
    container_id: containerId,
    symbol: symbol,
    interval: "60",
    timezone: "Europe/Madrid",
    theme: "dark",
    style: "1",
    locale: "es",
    hide_top_toolbar: true,
    width: "100%",
    height: "100%"
  });
}
const widgets={
  tv_eurodolar:"FX:EURUSD",
  tv_bono_eu:"INDEX:EXY",
  tv_oro:"OANDA:XAUUSD",  
  tv_brent:"TVC:UKOIL",
  tv_btc:"BINANCE:BTCUSDT",
  tv_dxy:"INDEX:DXY",
  tv_bono_us:"US10Y",
  tv_nasdaq:"NASDAQ:NDX",
  tv_sp500:"OANDA:SPX500USD",
  tv_vix:"CAPITALCOM:VIX",
};
for(const id in widgets) crearWidget(widgets[id],id);

// ==== CFD REAL-TIME ====
let cfdData=[], lastClose=100;
const canvas=document.getElementById("cfd-canvas");
const ctx=canvas.getContext("2d");

function resizeCanvas(){ canvas.width=canvas.parentElement.clientWidth; canvas.height=canvas.parentElement.clientHeight; }
window.addEventListener("resize",()=>{ resizeCanvas(); drawCFD(); });
resizeCanvas();

// Activos
const euroActivos=["tv_eurodolar","tv_bono_eu","tv_oro","tv_brent","tv_btc"];
const dolarActivos=["tv_dxy","tv_bono_us","tv_nasdaq","tv_sp500","tv_vix"];
let pesosEuro={ tv_eurodolar:1, tv_bono_eu:0.8, tv_oro:0.5, tv_brent:0.3, tv_btc:0.2 };
let pesosDolar={ tv_dxy:1, tv_bono_us:0.8, tv_nasdaq:0.6, tv_sp500:0.6, tv_vix:0.4 };
let precios={};
for(const id of [...euroActivos,...dolarActivos]) precios[id]=100+Math.random()*10;

// ==== FUNCIONES PARA API REAL ====
// Ejemplo Alpha Vantage y FRED
const ALPHA_API = "R1WOTVEJSD72AXY1";
const FRED_API = "bed081ca24cc84210d10d9ef952fe178";

async function fetchAlpha(symbol){
  try {
    const resp = await fetch(`https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=${symbol.split(':')[1]}&to_currency=${symbol.split(':')[0]}&apikey=${ALPHA_API}`);
    const data = await resp.json();
    return parseFloat(data["Realtime Currency Exchange Rate"]["5. Exchange Rate"]);
  } catch(e){ return null; }
}

async function fetchFred(series_id){
  try {
    const resp = await fetch(`https://api.stlouisfed.org/fred/series/observations?series_id=${series_id}&api_key=${FRED_API}&file_type=json`);
    const data = await resp.json();
    if(data.observations && data.observations.length>0){
      return parseFloat(data.observations[data.observations.length-1].value);
    }
    return null;
  } catch(e){ return null; }
}

// ==== CALCULAR CFD CON DATOS REALES ====
async function calcularCFD(){
  let sumEuro=0, totalEuro=0;
  for(const id of euroActivos){
    let price = precios[id];
    if(id==="tv_eurodolar") price = await fetchAlpha("EUR/USD") || price;
    precios[id] = price;
    sumEuro += price * pesosEuro[id];
    totalEuro += pesosEuro[id];
  }

  let sumDolar=0, totalDolar=0;
  for(const id of dolarActivos){
    let price = precios[id];
    if(id==="tv_dxy") price = await fetchFred("DTWEXBGS") || price; // ejemplo FRED DXY
    precios[id] = price;
    sumDolar += price * pesosDolar[id];
    totalDolar += pesosDolar[id];
  }

  return (sumEuro/totalEuro - sumDolar/totalDolar)+100;
}

// ==== SEÃ‘ALES CFD ====
let lastSignal=0; 
const SIGNAL_PIPS = 0.25; 

async function generarVela(){ 
  const open=lastClose; 
  const close=await calcularCFD(); 
  const high=Math.max(open,close)+Math.random()*0.2; 
  const low=Math.min(open,close)-Math.random()*0.2; 
  lastClose=close; 

  if(Math.abs(close-lastSignal)>=SIGNAL_PIPS){
    const tipo = close>lastSignal?"COMPRA":"VENTA";
    showAlert(`${tipo} CFD @ ${close.toFixed(2)}`);
    lastSignal=close;
  }

  return {open,high,low,close};
}

function initCFD(){ 
  for(let i=0;i<50;i++){ generarVela().then(v=>{ cfdData.push(v); drawCFD(); }); }
}
function drawCFD(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const padding=40, width=canvas.width-padding*2, height=canvas.height-padding*2;
  const max=Math.max(...cfdData.map(v=>v.high));
  const min=Math.min(...cfdData.map(v=>v.low));

  cfdData.forEach((v,i)=>{
    const x=padding + i/(cfdData.length-1)*width;
    const yOpen=padding + (max-v.open)/(max-min)*height;
    const yClose=padding + (max-v.close)/(max-min)*height;
    const yHigh=padding + (max-v.high)/(max-min)*height;
    const yLow=padding + (max-v.low)/(max-min)*height;
    ctx.strokeStyle="#888"; ctx.beginPath(); ctx.moveTo(x,yHigh); ctx.lineTo(x,yLow); ctx.stroke();
    ctx.fillStyle=(v.close>=v.open)?"#0f0":"#f00";
    ctx.fillRect(x-6,Math.min(yOpen,yClose),12,Math.max(2,Math.abs(yClose-yOpen)));
  });

  ctx.strokeStyle="#888"; ctx.beginPath();
  ctx.moveTo(padding,padding); ctx.lineTo(padding,canvas.height-padding);
  ctx.lineTo(canvas.width-padding,canvas.height-padding); ctx.stroke();
  ctx.fillStyle="#fff"; ctx.font="12px monospace";
  ctx.fillText(max.toFixed(2),5,padding);
  ctx.fillText(min.toFixed(2),5,canvas.height-padding);

  const step=Math.max(1,Math.floor(cfdData.length/5));
  for(let i=0;i<cfdData.length;i+=step){
    const x=padding + i/(cfdData.length-1)*width;
    ctx.fillText(i,x-5,canvas.height-10);
  }
}

async function updateCFD(){ 
  const v = await generarVela(); 
  cfdData.push(v); 
  if(cfdData.length>50) cfdData.shift(); 
  drawCFD(); 
}
initCFD();
setInterval(updateCFD,2000);

// ==== MINI CHAT IA ====
const iaConsole = document.getElementById("ia-console");
let chatHistory = [];

function logConsole(user, text){
  const timestamp = new Date().toLocaleTimeString();
  const newLine = `[${timestamp}] ${user}: ${text}`;
  chatHistory.push(newLine);
  iaConsole.innerText = chatHistory.slice(-20).reverse().join("\n");
}

function sendMessage(){
  const input = document.getElementById("chat-input");
  const msg = input.value.trim();
  if(!msg) return;
  input.value = "";
  logConsole("TÃº", msg);
  processMessage(msg);
}

function processMessage(msg){
  let response = "";
  if(msg.toLowerCase().includes("precio del oro")){
    response = `El precio del oro es ${(1800 + Math.random()*50).toFixed(2)} USD/onza ðŸª™`;
  } else if(msg.toLowerCase().includes("eur/usd")){
    response = `EUR/USD estÃ¡ en ${(1.08 + Math.random()*0.01).toFixed(4)}`;
  } else if(msg.toLowerCase().includes("noticia")){
    response = "Noticia recibida y analizada âš¡";
  } else {
    response = "Pol Millone responde: Entendido âœ”ï¸";
  }
  setTimeout(()=> logConsole("IA", response), 500);
}

// ==== ALERTAS ====
function showAlert(msg){
  const box=document.getElementById("alertBox");
  if([...box.childNodes].some(n=>n.innerText===msg)) return; 
  const div=document.createElement("div");
  div.className="alert";
  div.innerText=msg;
  box.appendChild(div);
  setTimeout(()=>div.remove(),7000);
}

// ==== NOTICIAS EXTERNAS ====
async function updateExternalNews(){
  const demoArticles=[
    {title:"EUR/USD rompe soporte diario", publishedAt:new Date(), source:{name:"Demo News"}}
  ];
  demoArticles.forEach(a=>{
    logConsole("Noticia", `${a.title} (${a.source.name})`);
  });
}
setInterval(updateExternalNews,30000);

</script>
</body>
</html>
