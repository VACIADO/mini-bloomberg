<!-- PANEL CFD POLMILLONE CON SCROLL Y ZOOM -->
<div class="panel" id="panel-cfd">
<h2>CFD ‚Äì Polmillone Sint√©tico</h2>

<div class="cfd-controls">
  <label>Tipo de vela:
    <select id="cfd_style" onchange="updateCFDStyle()">
      <option value="candles">Velas Japonesas</option>
      <option value="bars">Barras</option>
      <option value="line">L√≠nea</option>
    </select>
  </label>
  <label>Intervalo:
    <select id="cfd_interval" onchange="updateCFDInterval()">
      <option value="1">1 Min</option>
      <option value="5">5 Min</option>
      <option value="15">15 Min</option>
      <option value="60">1 Hora</option>
    </select>
  </label>
</div>

<div id="tv_cfd_scroll" style="flex:1; overflow:auto; border-radius:6px; background:#1e1e1e;"></div>
<div id="ia-console">Consola de IA activa... Analizando correlaciones en tiempo real.</div>
</div>

<script>
let euroActivos=["tv_eurodolar","tv_bono_eu","tv_oro","tv_brent","tv_btc"];
let dolarActivos=["tv_dxy","tv_bono_us","tv_nasdaq","tv_sp500","tv_vix"];
let pesosEuro={ tv_eurodolar:1, tv_bono_eu:0.8, tv_oro:0.5, tv_brent:0.3, tv_btc:0.2 };
let pesosDolar={ tv_dxy:1, tv_bono_us:0.8, tv_nasdaq:0.6, tv_sp500:0.6, tv_vix:0.4 };
let precios={};
for(const id of [...euroActivos,...dolarActivos]) precios[id]=100+Math.random()*10;

let cfdData=[];
let cfdStyle='candles';
let totalPoints=500; // historial largo
let updateInterval=2000;
let zoomX=1; // zoom horizontal
let zoomY=1; // zoom vertical

function calcularCFD(){
  let sumEuro=0,totalEuro=0;
  for(const id of euroActivos){ precios[id]+=(Math.random()-0.5)*2; sumEuro+=precios[id]*pesosEuro[id]; totalEuro+=pesosEuro[id]; }
  let sumDolar=0,totalDolar=0;
  for(const id of dolarActivos){ precios[id]+=(Math.random()-0.5)*2; sumDolar+=precios[id]*pesosDolar[id]; totalDolar+=pesosDolar[id]; }
  return (sumEuro/totalEuro - sumDolar/totalDolar)+100;
}

// Inicializar historial
for(let i=0;i<totalPoints;i++) cfdData.push({time:i,value:calcularCFD()});

// Dibujar CFD con zoom y scroll
function drawCFDScroll(){
  const container=document.getElementById("tv_cfd_scroll");
  container.innerHTML="";
  const canvas=document.createElement("canvas");
  canvas.height=container.clientHeight;
  canvas.width=cfdData.length*zoomX;
  container.appendChild(canvas);
  const ctx=canvas.getContext("2d");

  const padding=40;
  const width=canvas.width-padding*2;
  const height=(canvas.height-padding*2)*zoomY;
  const values=cfdData.map(d=>d.value);
  const max=Math.max(...values);
  const min=Math.min(...values);

  for(let i=0;i<cfdData.length;i++){
    const x=padding+i/(cfdData.length-1)*width;
    const y=padding+(max-cfdData[i].value)/(max-min)*height;

    if(cfdStyle==='line' && i>0){
      ctx.beginPath();
      const prevX=padding+(i-1)/(cfdData.length-1)*width;
      const prevY=padding+(max-cfdData[i-1].value)/(max-min)*height;
      ctx.moveTo(prevX,prevY);
      ctx.lineTo(x,y);
      ctx.strokeStyle="#00ff00";
      ctx.stroke();
    } else {
      const barWidth=width/cfdData.length*0.6;
      ctx.fillStyle=(i>0 && cfdData[i].value>cfdData[i-1].value)?"#0f0":"#f00";
      ctx.fillRect(x-barWidth/2,y,barWidth,canvas.height-padding-y);
      if(cfdStyle==='candles') ctx.fillRect(x-barWidth/4,y,barWidth/2,2);
    }
  }

  // Ejes
  ctx.strokeStyle="#888";
  ctx.beginPath();
  ctx.moveTo(padding,padding);
  ctx.lineTo(padding,canvas.height-padding);
  ctx.lineTo(canvas.width-padding,canvas.height-padding);
  ctx.stroke();

  // Escalas
  ctx.fillStyle="#fff";
  ctx.font="12px monospace";
  ctx.fillText(max.toFixed(2),5,padding);
  ctx.fillText(min.toFixed(2),5,canvas.height-padding);
  ctx.fillText("0",padding,canvas.height-5);
  ctx.fillText(cfdData.length-1,canvas.width-padding-10,canvas.height-5);
}

// Controles
function updateCFDStyle(){cfdStyle=document.getElementById("cfd_style").value; drawCFDScroll();}
function updateCFDInterval(){updateInterval=parseInt(document.getElementById("cfd_interval").value)*1000;}

// Zoom con rueda del rat√≥n
document.getElementById("tv_cfd_scroll").addEventListener("wheel",function(e){
  if(e.shiftKey){ // Shift+Scroll = horizontal
    zoomX=Math.min(Math.max(zoomX+e.deltaY*0.001,0.5),5);
  } else { // Scroll normal = vertical
    zoomY=Math.min(Math.max(zoomY-e.deltaY*0.001,0.5),5);
  }
  drawCFDScroll();
  e.preventDefault();
});

// Actualizaci√≥n continua
function updateCFD(){
  cfdData.push({time:cfdData.length,value:calcularCFD()});
  if(cfdData.length>totalPoints) cfdData.shift();
  drawCFDScroll();
}
setInterval(updateCFD, updateInterval);

// Simulaci√≥n IA
setInterval(()=>{
  const mensajes=[
    "EUR/USD y DXY correlaci√≥n negativa detectada üìâ",
    "BTC sigue tendencia alcista con volatilidad alta üöÄ",
    "S&P500 y Nasdaq muestran movimientos sincronizados üìä",
    "Brent y Oro sin correlaci√≥n significativa ‚öñÔ∏è"
  ];
  const c=document.getElementById("ia-console");
  c.innerText+=`\n${mensajes[Math.floor(Math.random()*mensajes.length)]}`;
  c.scrollTop=c.scrollHeight;
},8000);

// Inicializar
drawCFDScroll();
</script>
