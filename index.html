<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mini Bloomberg Pro ‚Äì CFD Real Time</title>
<style>
body { 
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #121212;
  color: #fff;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 10px;
  justify-content: center;
}
.panel {
  border: 1px solid #444;
  border-radius: 8px;
  background-color: #1e1e1e;
  box-sizing: border-box;
  padding: 10px;
  flex: 1 1 45%;
  min-width: 300px;
  display: flex;
  flex-direction: column;
  height: 420px;
}
h2 { margin: 0 0 5px 0; text-align: center; font-size: 1.1rem; }
.tradingview-widget-container { flex: 1; margin-top: 5px; border-radius: 6px; overflow: hidden; }
#ia-console { width: 100%; background: #000; color: #0f0; font-family: monospace; padding: 6px; height: 140px; overflow-y: auto; font-size: 0.8rem; margin-top: 8px; border-radius: 4px; border: 1px solid #444; }
.cfd-controls { display: flex; justify-content: space-between; margin-bottom: 5px; }
.cfd-controls select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 3px; font-size: 0.9rem; }
.news-panel { flex:1 1 45%; background:#121921; padding:10px; border-radius:6px; max-height:30vh; overflow-y:auto; }
.news-panel h3 { margin:0 0 5px 0; font-size:14px; }
.news { margin-bottom:6px; } 
.news span { font-weight:bold; } 
.alert { background:#7c2d12;color:#fff;padding:6px;text-align:center;font-weight:bold;margin:4px 0;border-radius:4px; }
canvas { image-rendering:pixelated; cursor: grab; background:#1e1e1e; }
</style>
</head>
<body>

<!-- PANEL EURO / CORRELADOS -->
<div class="panel" id="panel-eurodolar">
<h2>Euro / Correlados</h2>
<div class="tradingview-widget-container" id="tv_eurodolar"></div>
<div class="tradingview-widget-container" id="tv_bono_eu"></div>
<div class="tradingview-widget-container" id="tv_oro"></div>
<div class="tradingview-widget-container" id="tv_brent"></div>
<div class="tradingview-widget-container" id="tv_btc"></div>
</div>

<!-- PANEL DXY / CORRELADOS -->
<div class="panel" id="panel-dxy">
<h2>DXY / Correlados</h2>
<div class="tradingview-widget-container" id="tv_dxy"></div>
<div class="tradingview-widget-container" id="tv_bono_us"></div>
<div class="tradingview-widget-container" id="tv_nasdaq"></div>
<div class="tradingview-widget-container" id="tv_sp500"></div>
<div class="tradingview-widget-container" id="tv_vix"></div>
</div>

<!-- PANEL CFD REAL-TIME -->
<div class="panel" id="panel-cfd">
<h2>CFD Sint√©tico ‚Äì Real Time</h2>
<div class="cfd-controls">
  <label>Tipo:
    <select id="cfd_style" onchange="updateCFDStyle()">
      <option value="candles">Velas</option>
      <option value="line">L√≠nea</option>
      <option value="bars">Barras</option>
    </select>
  </label>
  <label>Intervalo:
    <select id="cfd_interval" onchange="updateCFDInterval()">
      <option value="1">1 Min</option>
      <option value="5">5 Min</option>
      <option value="15">15 Min</option>
      <option value="60">1 Hora</option>
    </select>
  </label>
</div>
<div class="tradingview-widget-container" id="tv_cfd"></div>
<div id="ia-console">Consola de IA activa...</div>
<div class="news-panel" id="news-before"><h3>Noticias Antes</h3></div>
<div class="news-panel" id="news-after"><h3>Noticias Despu√©s</h3></div>
<div id="alertBox"></div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
// === WIDGETS TRADINGVIEW ===
function crearWidget(symbol, containerId){
  document.getElementById(containerId).innerHTML="";
  new TradingView.widget({
    container_id: containerId,
    symbol: symbol,
    interval: "60",
    timezone: "Europe/Madrid",
    theme: "dark",
    style: "1",
    locale: "es",
    hide_top_toolbar: true,
    width: "100%",
    height: "100%"
  });
}
const widgets={
  tv_eurodolar:"FX:EURUSD",
  tv_bono_eu:"INDEX:EXY",
  tv_oro:"OANDA:XAUUSD",  
  tv_brent:"TVC:UKOIL",
  tv_btc:"BINANCE:BTCUSDT",
  tv_dxy:"INDEX:DXY",
  tv_bono_us:"US10Y",
  tv_nasdaq:"NASDAQ:NDX",
  tv_sp500:"OANDA:SPX500USD",
  tv_vix:"CAPITALCOM:VIX",
};
for(const id in widgets) crearWidget(widgets[id],id);

// === CFD REAL-TIME PROFESIONAL ===
let cfdData=[], lastClose=100, cfdStyle='candles', cfdInterval=1;
let canvas, ctx, scrollX=0, zoom=1, isDragging=false, dragStartX=0;

const euroActivos=["tv_eurodolar","tv_bono_eu","tv_oro","tv_brent","tv_btc"];
const dolarActivos=["tv_dxy","tv_bono_us","tv_nasdaq","tv_sp500","tv_vix"];
let pesosEuro={ tv_eurodolar:1, tv_bono_eu:0.8, tv_oro:0.5, tv_brent:0.3, tv_btc:0.2 };
let pesosDolar={ tv_dxy:1, tv_bono_us:0.8, tv_nasdaq:0.6, tv_sp500:0.6, tv_vix:0.4 };
let precios={};
for(const id of [...euroActivos,...dolarActivos]) precios[id]=100+Math.random()*10;

function calcularCFD(){
  let sumEuro=0, totalEuro=0;
  for(const id of euroActivos){ precios[id]+=(Math.random()-0.5)*0.5; sumEuro+=precios[id]*pesosEuro[id]; totalEuro+=pesosEuro[id]; }
  let sumDolar=0, totalDolar=0;
  for(const id of dolarActivos){ precios[id]+=(Math.random()-0.5)*0.5; sumDolar+=precios[id]*pesosDolar[id]; totalDolar+=pesosDolar[id]; }
  return 100 + (sumEuro/totalEuro - sumDolar/totalDolar);
}

// Inicializar canvas y controles
function initCFD(){
  const container=document.getElementById("tv_cfd");
  canvas=document.createElement("canvas");
  canvas.width=container.clientWidth;
  canvas.height=container.clientHeight;
  container.innerHTML="";
  container.appendChild(canvas);
  ctx=canvas.getContext("2d");

  canvas.addEventListener("mousedown", e=>{isDragging=true; dragStartX=e.offsetX; canvas.style.cursor="grabbing";});
  canvas.addEventListener("mouseup", e=>{isDragging=false; canvas.style.cursor="grab";});
  canvas.addEventListener("mouseleave", e=>{isDragging=false; canvas.style.cursor="grab";});
  canvas.addEventListener("mousemove", e=>{if(isDragging){scrollX+=e.offsetX-dragStartX; dragStartX=e.offsetX; drawCFD();}});

  canvas.addEventListener("wheel", e=>{e.preventDefault(); zoom *= e.deltaY<0?1.1:0.9; zoom=Math.min(Math.max(zoom,0.5),5); drawCFD();});

  for(let i=0;i<150;i++) cfdData.push({time:i,value:calcularCFD()});
  drawCFD();
}

function drawCFD(){
  const padding=50;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const width=canvas.width-padding*2;
  const height=canvas.height-padding*2;

  const values=cfdData.map(d=>d.value);
  const max=Math.max(...values);
  const min=Math.min(...values);

  // Grid horizontal y vertical
  ctx.strokeStyle="#444"; ctx.lineWidth=1;
  ctx.beginPath();
  for(let i=0;i<=5;i++){
    let y=padding+i*height/5;
    ctx.moveTo(padding,y); ctx.lineTo(canvas.width-padding,y);
  }
  for(let i=0;i<=5;i++){
    let x=padding+i*width/5*zoom+scrollX;
    ctx.moveTo(x,padding); ctx.lineTo(x,canvas.height-padding);
  }
  ctx.stroke();

  // Escalas
  ctx.fillStyle="#fff"; ctx.font="12px monospace";
  ctx.fillText(max.toFixed(2),5,padding);
  ctx.fillText(min.toFixed(2),5,canvas.height-padding);

  // Tiempos
  const step=Math.max(1,Math.floor(cfdData.length/5));
  for(let i=0;i<cfdData.length;i+=step){
    const x=padding + (i/(cfdData.length-1)*width*zoom) + scrollX;
    ctx.fillText(cfdData[i].time,x-10,canvas.height-5);
  }

  // Dibujar velas/l√≠nea/barras
  const barWidth=(width/cfdData.length*0.6)*zoom;
  for(let i=0;i<cfdData.length;i++){
    const x=padding + (i/(cfdData.length-1)*width*zoom) + scrollX;
    const y=padding+(max-cfdData[i].value)/(max-min)*height;
    if(cfdStyle==='line' && i>0){
      const prevY=padding+(max-cfdData[i-1].value)/(max-min)*height;
      const prevX=padding + ((i-1)/(cfdData.length-1)*width*zoom) + scrollX;
      ctx.strokeStyle="#0f0";
      ctx.beginPath();
      ctx.moveTo(prevX,prevY);
      ctx.lineTo(x,y);
      ctx.stroke();
    } else {
      const prev=cfdData[i-1];
      const color=(i>0 && cfdData[i].value>prev.value)?"#0f0":"#f00";
      ctx.fillStyle=color;
      ctx.fillRect(x-barWidth/2,y,barWidth,canvas.height-padding-y);
    }
  }
}

// Actualizar CFD
function updateCFD(){
  cfdData.push({time:cfdData.length,value:calcularCFD()});
  if(cfdData.length>300) cfdData.shift();
  drawCFD();
}
setInterval(updateCFD,3000);

// Controles
function updateCFDStyle(){ cfdStyle=document.getElementById("cfd_style").value; drawCFD(); }
function updateCFDInterval(){ cfdInterval=parseInt(document.getElementById("cfd_interval").value); }

// === IA SOPORTE/RESISTENCIA ===
function logConsole(text){ 
  const c=document.getElementById("ia-console"); 
  c.innerText+="\n"+text; 
  c.scrollTop=c.scrollHeight; 
}
function detectSupportResistance(){
  const values=cfdData.map(d=>d.value);
  const max=Math.max(...values), min=Math.min(...values);
  logConsole(`Soporte ‚âà ${min.toFixed(2)}, Resistencia ‚âà ${max.toFixed(2)}`);
}
setInterval(()=>{
  const msgs=["EUR/USD y DXY correlaci√≥n negativa üìâ","BTC alcista üöÄ","S&P500 y Nasdaq sincronizados üìä","Brent y Oro sin correlaci√≥n ‚öñÔ∏è","Analizando soportes EUR/USD..."];
  logConsole(msgs[Math.floor(Math.random()*msgs.length)]);
  detectSupportResistance();
},10000);

// === ALERTAS ===
function showAlert(msg){ 
  const box=document.getElementById("alertBox"); 
  const div=document.createElement("div"); 
  div.className="alert"; 
  div.innerText=msg; 
  box.appendChild(div); 
  setTimeout(()=>div.remove(),5000);
}
setInterval(()=>{ if(Math.random()<0.2) showAlert("‚ö° Alerta CFD rompe soporte/resistencia!"); },7000);

// === NOTICIAS ===
async function fetchNewsRealtime(query="EUR/USD"){
  try{
    const url=`https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=es&sortBy=publishedAt&apiKey=pub_b272af150959422caa98464f57f2f31b`;
    const res=await fetch(url);
    const json=await res.json();
    return json.articles||[];
  }catch(e){console.error(e); return [];}
}
function displayNews(beforeAfter, articles){
  const container=document.getElementById(beforeAfter==="before"?"news-before":"news-after");
  container.innerHTML=`<h3>Noticias ${beforeAfter==="before"?"Antes":"Despu√©s"}</h3>`;
  articles.forEach(a=>{
    const div=document.createElement("div"); div.className="news";
    div.innerHTML=`<span>${new Date(a.publishedAt).toLocaleTimeString()}:</span> ${a.title}<br><small>${a.source.name}</small>`;
    container.appendChild(div);
  });
}
async function updateNewsPanels(){
  const news=await fetchNewsRealtime("EUR/USD");
  displayNews("before",news.slice(0,5));
  displayNews("after",news.slice(5,10));
}
updateNewsPanels();
setInterval(updateNewsPanels,30000);

// === INICIO ===
initCFD();
</script>
</body>
</html>
