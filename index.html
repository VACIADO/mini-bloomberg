<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mini Bloomberg Pro ‚Äì CFD Real Time</title>
<style>
body { 
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #121212;
  color: #fff;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 10px;
  justify-content: center;
}
.panel {
  border: 1px solid #444;
  border-radius: 8px;
  background-color: #1e1e1e;
  box-sizing: border-box;
  padding: 10px;
  flex: 1 1 45%;
  min-width: 300px;
  display: flex;
  flex-direction: column;
  height: 420px;
}
h2 { margin: 0 0 5px 0; text-align: center; font-size: 1.1rem; }
.tradingview-widget-container { flex: 1; margin-top: 5px; border-radius: 6px; overflow: hidden; }
#ia-console { width: 100%; background: #000; color: #0f0; font-family: monospace; padding: 6px; height: 120px; overflow-y: auto; font-size: 0.8rem; margin-top: 8px; border-radius: 4px; border: 1px solid #444; }
.cfd-controls { display: flex; justify-content: space-between; margin-bottom: 5px; }
.cfd-controls select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 3px; font-size: 0.9rem; }
.news-container { display:flex; gap:6px; flex:1; margin-top:5px; }
.news-panel { flex:1; background:#121921; padding:10px; border-radius:6px; max-height:150px; overflow-y:auto; }
.news-panel h3 { margin:0 0 5px 0; font-size:14px; }
.news{margin-bottom:6px;} .news span{font-weight:bold;}
.alert{background:#7c2d12;color:#fff;padding:6px;text-align:center;font-weight:bold;margin:4px 0;border-radius:4px;}
canvas{image-rendering:pixelated;}
</style>
</head>
<body>

<!-- PANEL EURO / CORRELADOS -->
<div class="panel" id="panel-eurodolar">
<h2>Euro / Correlados</h2>
<div class="tradingview-widget-container" id="tv_eurodolar"></div>
<div class="tradingview-widget-container" id="tv_bono_eu"></div>
<div class="tradingview-widget-container" id="tv_oro"></div>
<div class="tradingview-widget-container" id="tv_brent"></div>
<div class="tradingview-widget-container" id="tv_btc"></div>
</div>

<!-- PANEL DXY / CORRELADOS -->
<div class="panel" id="panel-dxy">
<h2>DXY / Correlados</h2>
<div class="tradingview-widget-container" id="tv_dxy"></div>
<div class="tradingview-widget-container" id="tv_bono_us"></div>
<div class="tradingview-widget-container" id="tv_nasdaq"></div>
<div class="tradingview-widget-container" id="tv_sp500"></div>
<div class="tradingview-widget-container" id="tv_vix"></div>
</div>

<!-- PANEL CFD INTERACTIVO -->
<div class="panel" id="panel-cfd">
<h2>CFD Sint√©tico ‚Äì Interactivo</h2>
<div class="cfd-controls">
  <label>Intervalo:
    <select id="cfd_interval" onchange="updateCFDInterval()">
      <option value="1">1 Min</option>
      <option value="5">5 Min</option>
      <option value="15">15 Min</option>
      <option value="60">1 Hora</option>
    </select>
  </label>
</div>
<div class="tradingview-widget-container" id="tv_cfd_interactive" style="flex:1;position:relative;"></div>
<div id="ia-console">Consola de IA activa...</div>
<div class="news-container">
  <div class="news-panel" id="news-before"><h3>Noticias Antes</h3></div>
  <div class="news-panel" id="news-after"><h3>Noticias Despu√©s</h3></div>
</div>
<div id="alertBox"></div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
// ==== TRADINGVIEW ORIGINAL ====
function crearWidget(symbol, containerId){
  document.getElementById(containerId).innerHTML="";
  new TradingView.widget({
    container_id: containerId,
    symbol: symbol,
    interval: "60",
    timezone: "Europe/Madrid",
    theme: "dark",
    style: "1",
    locale: "es",
    hide_top_toolbar: true,
    width: "100%",
    height: "100%"
  });
}
const widgets={
  tv_eurodolar:"FX:EURUSD",
  tv_bono_eu:"INDEX:EXY",
  tv_oro:"OANDA:XAUUSD",  
  tv_brent:"TVC:UKOIL",
  tv_btc:"BINANCE:BTCUSDT",
  tv_dxy:"INDEX:DXY",
  tv_bono_us:"US10Y",
  tv_nasdaq:"NASDAQ:NDX",
  tv_sp500:"OANDA:SPX500USD",
  tv_vix:"CAPITALCOM:VIX",
};
for(const id in widgets) crearWidget(widgets[id],id);

// ==== CFD INTERACTIVO ====
let cfdData=[], lastClose=100, cfdInterval=1;
const containerCFD=document.getElementById("tv_cfd_interactive");
const canvas=document.createElement("canvas");
containerCFD.appendChild(canvas);
const ctx=canvas.getContext("2d");
canvas.width=containerCFD.clientWidth;
canvas.height=containerCFD.clientHeight;
let offset=0, zoom=1;
let isDragging=false, startX;

// Traer precios reales desde tu API
async function fetchCFDPrice(){
  try{
    const res=await fetch("https://api.publink.com/cfd?symbol=EURUSD&key=pub_b272af150959422caa98464f57f2f31b");
    const data=await res.json();
    return parseFloat(data.price) || lastClose;
  }catch(e){ console.error(e); return lastClose; }
}

// Generar vela
async function generarVelaReal(){
  const close=await fetchCFDPrice();
  const open=lastClose;
  const high=Math.max(open,close)+(Math.random()*0.1);
  const low=Math.min(open,close)-(Math.random()*0.1);
  lastClose=close;
  return {open,high,low,close};
}

// Inicializar CFD
async function initCFDInteractive(){
  for(let i=0;i<100;i++) cfdData.push(await generarVelaReal());
  drawCFDInteractive();
}
initCFDInteractive();

// Dibujar CFD interactivo
function drawCFDInteractive(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const padding=40;
  const width=canvas.width-padding*2;
  const height=canvas.height-padding*2;
  const visibleCount=Math.floor(cfdData.length/zoom);
  const start=Math.max(0,cfdData.length-visibleCount-offset);
  const visibleData=cfdData.slice(start,start+visibleCount);
  const max=Math.max(...visibleData.map(v=>v.high));
  const min=Math.min(...visibleData.map(v=>v.low));

  visibleData.forEach((v,i)=>{
    const x=padding+i/(visibleCount-1)*width;
    const yOpen=padding+(max-v.open)/(max-min)*height;
    const yClose=padding+(max-v.close)/(max-min)*height;
    const yHigh=padding+(max-v.high)/(max-min)*height;
    const yLow=padding+(max-v.low)/(max-min)*height;
    ctx.strokeStyle="#888"; ctx.beginPath();
    ctx.moveTo(x,yHigh); ctx.lineTo(x,yLow); ctx.stroke();
    ctx.fillStyle=(v.close>=v.open)?"#0f0":"#f00";
    ctx.fillRect(x-5,Math.min(yOpen,yClose),10,Math.max(2,Math.abs(yClose-yOpen)));
  });

  ctx.strokeStyle="#888"; ctx.beginPath();
  ctx.moveTo(padding,padding); ctx.lineTo(padding,canvas.height-padding); ctx.lineTo(canvas.width-padding,canvas.height-padding); ctx.stroke();
}

// Actualizar CFD
async function updateCFDInteractive(){
  cfdData.push(await generarVelaReal());
  if(cfdData.length>200) cfdData.shift();
  drawCFDInteractive();
}
setInterval(updateCFDInteractive,2000);

// Zoom y desplazamiento
canvas.addEventListener("wheel", e=>{
  e.preventDefault();
  zoom+=e.deltaY*0.001;
  if(zoom<0.5) zoom=0.5;
  if(zoom>5) zoom=5;
  drawCFDInteractive();
});
canvas.addEventListener("mousedown", e=>{isDragging=true; startX=e.clientX;});
canvas.addEventListener("mouseup", e=>{isDragging=false;});
canvas.addEventListener("mouseleave", e=>{isDragging=false;});
canvas.addEventListener("mousemove", e=>{
  if(isDragging){
    const dx=e.clientX-startX;
    offset+=Math.floor(dx/10);
    if(offset<0) offset=0;
    startX=e.clientX;
    drawCFDInteractive();
  }
});

// ==== IA ====
function logConsole(text){ const c=document.getElementById("ia-console"); c.innerText+="\n"+text; c.scrollTop=c.scrollHeight; }
setInterval(()=>{
  const msgs=["EUR/USD y DXY correlaci√≥n negativa üìâ","BTC alcista üöÄ","S&P500 y Nasdaq sincronizados üìä","Brent y Oro sin correlaci√≥n ‚öñÔ∏è","Analizando soportes EUR/USD..."];
  logConsole(msgs[Math.floor(Math.random()*msgs.length)]);
},8000);

// ==== ALERTAS ====
function showAlert(msg){ const box=document.getElementById("alertBox"); const div=document.createElement("div"); div.className="alert"; div.innerText=msg; box.appendChild(div); setTimeout(()=>div.remove(),5000);}
setInterval(()=>{ if(Math.random()<0.2) showAlert("‚ö° Alerta CFD rompe soporte/resistencia!"); },7000);

// ==== NOTICIAS ====
async function fetchNewsRealtime(query="EUR/USD"){
  try{
    const url=`https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=es&sortBy=publishedAt&apiKey=pub_b272af150959422caa98464f57f2f31b`;
    const res=await fetch(url);
    const json=await res.json();
    return json.articles||[];
  }catch(e){console.error(e); return [];}
}
function displayNews(beforeAfter, articles){
  const container=document.getElementById(beforeAfter==="before"?"news-before":"news-after");
  container.innerHTML=`<h3>Noticias ${beforeAfter==="before"?"Antes":"Despu√©s"}</h3>`;
  articles.forEach(a=>{
    const div=document.createElement("div"); div.className="news";
    div.innerHTML=`<span>${new Date(a.publishedAt).toLocaleTimeString()}:</span> ${a.title}<br><small>${a.source.name}</small>`;
    container.appendChild(div);
  });
}
async function updateNewsPanels(){
  const news=await fetchNewsRealtime("EUR/USD");
  displayNews("before",news.slice(0,5));
  displayNews("after",news.slice(5,10));
}
updateNewsPanels();
setInterval(updateNewsPanels,30000);

// Controles intervalo CFD
function updateCFDInterval(){cfdInterval=parseInt(document.getElementById("cfd_interval").value);}
</script>
</body>
</html>
